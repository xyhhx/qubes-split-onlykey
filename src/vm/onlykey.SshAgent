#!/bin/bash
set -euo pipefail

self="$(qubesdb-read /name)"
log_file="${HOME}/onlykey-agent.log"
sock_path="${XDG_RUNTIME_DIR:-"/tmp"}/onlykey-agent-${1}.sock"
ssh_identity="$(sed 's/_/@/' "${1}")"

if [[ -z "${ssh_identity}" ]]; then
  notify-send "[${self}] No SSH identity passed. Aborting" >&2
  exit 1
fi

# onlykey-agent -d daemonizes the agent, and prints the unix socket path
# we can consume this output to update our environment and point to the appropriate agent socket
. <(onlykey-agent "${ssh_identity}" -d -vv --log-file "${log_file}" --sock-path "${sock_path}")

# safeguard - Qubes notification bubble for each ssh request
notify-send "[${self}] SSH agent access from: ${QREXEC_REMOTE_DOMAIN} for ${ssh_identity}"

# SSH connection
socat - "unix-connect:${SSH_AUTH_SOCK}"
