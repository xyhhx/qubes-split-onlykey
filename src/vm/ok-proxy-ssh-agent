#!/bin/bash
set -euo pipefail

validate_qrexec_target() {
	if [[ ! "${1}" =~ ^[A-Za-z@][:0-9A-Za-z_-]*$ ]]; then
		printf 'Qrexec target (%q) is invalid\n' "${1}" >&2
		exit 1
	fi
}

SYS_ONLYKEY_DOMAIN="${SYS_ONLYKEY_DOMAIN:-"@default"}"
SSH_IDENTITY="${1:-$SSH_IDENTITY}"

validate_qrexec_target "${SYS_ONLYKEY_DOMAIN}"

agent_socket="${XDG_RUNTIME_DIR:-"/tmp"}/split-ok-ssh_${SYS_ONLYKEY_DOMAIN}.sock"

umask 177 && exec socat \
	"unix-listen:'${agent_socket}',fork,unlink-early" \
	"exec:qrexec-client-vm ${SYS_ONLYKEY_DOMAIN} onlykey.SshAgent+${SSH_IDENTITY}" 

